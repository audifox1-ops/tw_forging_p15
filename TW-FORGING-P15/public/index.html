<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒì‚°ê¸°ìˆ  ê²¬ì  ê²€í†  ì‹œìŠ¤í…œ</title>
    <!-- Tailwind CSS -->
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <!-- FontAwesome -->
    <link href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css)" rel="stylesheet">
    <!-- SheetJS (ì—‘ì…€ ë³€í™˜) -->
    <script src="[https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js](https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js)"></script>
    <!-- Tesseract.js (OCR) -->
    <script src="[https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js](https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js)"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div class="max-w-6xl mx-auto p-6">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fa-solid fa-industry text-blue-600 mr-2"></i>ê²¬ì  ê²€í†  ìë™ ë¶„ì„ ì‹œìŠ¤í…œ
            </h1>
            <p class="text-gray-500">ì—‘ì…€(.xlsx) íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ <strong>í™”ë©´ì„ ìº¡ì²˜í•˜ì—¬ ë¶™ì—¬ë„£ê¸°(Ctrl+V)</strong>í•˜ì„¸ìš”.</p>
            <div id="statusBadge" class="mt-3 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                <span class="w-2 h-2 mr-2 rounded-full bg-gray-400"></span> ëŒ€ê¸° ì¤‘
            </div>
        </header>

        <div class="bg-white p-8 rounded-xl shadow-md border border-dashed border-gray-300 text-center hover:border-blue-500 transition-colors focus-within:border-blue-500" id="dropzone" tabindex="0">
            <div class="space-y-4">
                <div class="text-5xl text-blue-100">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                </div>
                <h3 class="text-xl font-semibold">íŒŒì¼ ë“œë˜ê·¸ ë˜ëŠ” <span class="text-blue-600">Ctrl+V</span> (ë¶™ì—¬ë„£ê¸°)</h3>
                <div class="text-sm text-gray-400">
                    <p>ì§€ì›: ì—‘ì…€(.xlsx), CSV, ì´ë¯¸ì§€(ë„ë©´ ìº¡ì²˜)</p>
                </div>
                <input type="file" id="fileInput" class="hidden" accept=".csv,.xlsx,.xls,image/*">
                <button onclick="document.getElementById('fileInput').click()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    íŒŒì¼ ì„ íƒí•˜ê¸°
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden mt-8 text-center">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-blue-200 border-t-blue-600"></div>
            <p class="mt-3 text-gray-600 font-medium" id="loadingTitle">ë¶„ì„ ì¤‘...</p>
            <div id="ocrProgressContainer" class="hidden w-64 mx-auto mt-3 bg-gray-200 rounded-full h-2.5">
                <div id="ocrProgressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <!-- Results -->
        <div id="resultArea" class="hidden mt-8 space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">ğŸ“Š ë¶„ì„ ê²°ê³¼</h2>
                <span id="fileNameDisplay" class="text-sm bg-gray-200 px-3 py-1 rounded-full text-gray-600"></span>
            </div>

            <!-- Simulation Notice -->
            <div id="simulationNotice" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fa-solid fa-triangle-exclamation text-yellow-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            <strong>[ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œ]</strong> ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í•˜ì—¬ ë¸Œë¼ìš°ì € ìì²´ ë¶„ì„ ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.<br>
                            * Vercel ë°°í¬ í›„ì—ëŠ” AI ì •ë°€ ë¶„ì„ì´ ì‘ë™í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">í˜•ìƒ/ì¬ì§ˆ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì œí’ˆ ì¹˜ìˆ˜ (Input)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë‹¨ì¡° ì¹˜ìˆ˜ (Output)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì—¬ìœ ì¹˜</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ingot / íšŒìˆ˜ìœ¨</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');
        const loading = document.getElementById('loading');
        const resultArea = document.getElementById('resultArea');
        const tableBody = document.getElementById('resultTableBody');
        const simulationNotice = document.getElementById('simulationNotice');
        const statusBadge = document.getElementById('statusBadge');
        
        // í™˜ê²½ ê°ì§€
        const isPreviewEnv = window.location.hostname.includes('lovable') || window.location.protocol === 'file:';

        function updateStatus(msg, type = 'default') {
            const colors = {
                default: ['bg-gray-100', 'text-gray-600', 'bg-gray-400'],
                loading: ['bg-blue-100', 'text-blue-600', 'bg-blue-400'],
                success: ['bg-green-100', 'text-green-600', 'bg-green-400'],
                error: ['bg-red-100', 'text-red-600', 'bg-red-400']
            };
            const c = colors[type];
            statusBadge.className = `mt-3 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${c[0]} ${c[1]}`;
            statusBadge.innerHTML = `<span class="w-2 h-2 mr-2 rounded-full ${c[2]}"></span> ${msg}`;
        }

        if (isPreviewEnv) updateStatus("ë¡œì»¬/ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ (ì„œë²„ ì—†ìŒ)");

        // Event Listeners
        document.addEventListener('paste', handlePaste);
        dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('border-blue-500'); });
        dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-blue-500'));
        dropzone.addEventListener('drop', e => {
            e.preventDefault();
            dropzone.classList.remove('border-blue-500');
            if(e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => { if(e.target.files.length) processFile(e.target.files[0]); });

        function handlePaste(e) {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const file = items[i].getAsFile();
                    processFile(file);
                    break;
                }
            }
        }

        async function processFile(file) {
            // UI Reset
            resultArea.classList.add('hidden');
            simulationNotice.classList.add('hidden');
            loading.classList.remove('hidden');
            tableBody.innerHTML = '';
            document.getElementById('fileNameDisplay').textContent = file.name;
            updateStatus("ë°ì´í„° ë¶„ì„ ì¤‘...", "loading");

            let fileToUpload = file;
            let textContentForSim = "";

            try {
                // 1. íŒŒì¼ ì „ì²˜ë¦¬ (ì—‘ì…€/ì´ë¯¸ì§€ -> í…ìŠ¤íŠ¸ ë³€í™˜ ì¤€ë¹„)
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const ab = await file.arrayBuffer();
                    const wb = XLSX.read(ab);
                    const sheet = wb.Sheets[wb.SheetNames[0]]; // ì²« ì‹œíŠ¸ (ê°„ì†Œí™”)
                    textContentForSim = XLSX.utils.sheet_to_csv(sheet);
                    fileToUpload = new File([textContentForSim], "data.csv", { type: "text/csv" });
                } else if (file.type.startsWith('image/')) {
                    const worker = await Tesseract.createWorker('eng');
                    const ret = await worker.recognize(file);
                    await worker.terminate();
                    textContentForSim = ret.data.text;
                    fileToUpload = new File([textContentForSim], "ocr.txt", { type: "text/plain" });
                } else {
                    textContentForSim = await file.text();
                }

                // 2. ì„œë²„ ì „ì†¡ ì‹œë„
                if (isPreviewEnv) throw new Error("PREVIEW_MODE");

                const formData = new FormData();
                formData.append('file', fileToUpload);

                const res = await fetch('/api/analyze', { method: 'POST', body: formData });
                if (!res.ok) throw new Error(res.status === 404 ? "API_NOT_FOUND" : "SERVER_ERROR");
                
                const result = await res.json();
                renderTable(result.data.items);
                updateStatus("AI ë¶„ì„ ì™„ë£Œ", "success");

            } catch (err) {
                // 3. ì—ëŸ¬ ë°œìƒ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ
                console.warn("Falling back to simulation:", err.message);
                
                const simItems = simulateAnalysis(textContentForSim, file.name);
                renderTable(simItems);
                simulationNotice.classList.remove('hidden');
                updateStatus("ë¸Œë¼ìš°ì € ìì²´ ë¶„ì„ ì™„ë£Œ", "error");
            } finally {
                loading.classList.add('hidden');
                resultArea.classList.remove('hidden');
            }
        }

        // ê°„ë‹¨ ì‹œë®¬ë ˆì´ì…˜ ë¡œì§ (ì„œë²„ ì—†ì„ ë•Œ)
        function simulateAnalysis(text, filename) {
            const rows = text.split('\n');
            const items = [];
            rows.forEach((r, i) => {
                const nums = r.match(/\d+(\.\d+)?/g)?.map(Number) || [];
                if (nums.length >= 6) { // ìˆ«ì 6ê°œ ì´ìƒì´ë©´ ë°ì´í„°ë¡œ ê°„ì£¼
                    items.push({
                        rowId: i+1,
                        productName: filename.includes('SHAFT') ? 'SHAFT' : 'SQUARE',
                        material: 'SA266',
                        inputSpec: { od: nums[0], id: nums[1], length: nums[2] },
                        outputSpec: { od: nums[3], id: nums[4], length: nums[5] },
                        weight: Math.max(...nums),
                        note: "ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°"
                    });
                }
            });
            return items.length ? items : [{ rowId: "-", note: "ë°ì´í„° íŒ¨í„´ ì¸ì‹ ì‹¤íŒ¨ (ì„œë²„ ë°°í¬ í•„ìš”)" }];
        }

        function renderTable(items) {
            tableBody.innerHTML = items.map(item => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.rowId || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${item.productName || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${fmt(item.inputSpec)}</td>
                    <td class="px-6 py-4 text-sm text-blue-600 font-medium">${fmt(item.outputSpec)}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${fmt(item.allowanceSpec) || 'Auto'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${item.ingotType || '-'} / ${item.recoveryRate || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 truncate max-w-xs">${item.note || ''}</td>
                </tr>
            `).join('');
        }

        function fmt(dim) {
            if (!dim) return '-';
            return Object.entries(dim).map(([k, v]) => `${k.toUpperCase().substr(0,1)}:${v}`).join(' ');
        }
    </script>
</body>
</html>
