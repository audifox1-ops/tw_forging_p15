<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒì‚°ê¸°ìˆ  ê²¬ì  ê²€í†  ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div class="max-w-6xl mx-auto p-6">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fa-solid fa-industry text-blue-600 mr-2"></i>ê²¬ì  ê²€í†  ìë™ ë¶„ì„ ì‹œìŠ¤í…œ
            </h1>
            <p class="text-gray-500">ì—‘ì…€(.xlsx) íŒŒì¼ ì—…ë¡œë“œ ë˜ëŠ” <strong>í™”ë©´ ìº¡ì²˜ ë¶™ì—¬ë„£ê¸°(Ctrl+V)</strong></p>
            <!-- í™˜ê²½ ìƒíƒœ í‘œì‹œ -->
            <div id="envStatus" class="mt-2 text-sm font-bold"></div>
        </header>

        <div class="bg-white p-8 rounded-xl shadow-md border border-dashed border-gray-300 text-center hover:border-blue-500 transition-colors" id="dropzone">
            <div class="space-y-4">
                <div class="text-5xl text-blue-100"><i class="fa-solid fa-cloud-arrow-up"></i></div>
                <h3 class="text-xl font-semibold">íŒŒì¼ ë“œë˜ê·¸ ë˜ëŠ” <span class="text-blue-600">Ctrl+V</span></h3>
                <input type="file" id="fileInput" class="hidden" accept=".csv,.xlsx,.xls,image/*">
                <button onclick="document.getElementById('fileInput').click()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">íŒŒì¼ ì„ íƒ</button>
            </div>
        </div>

        <div id="loading" class="hidden mt-8 text-center">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-blue-200 border-t-blue-600"></div>
            <p class="mt-3 text-gray-600" id="loadingText">ë¶„ì„ ì¤‘...</p>
        </div>

        <div id="resultArea" class="hidden mt-8 space-y-6">
            <h2 class="text-xl font-bold text-gray-800">ğŸ“Š ë¶„ì„ ê²°ê³¼</h2>
            <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">No.</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">í˜•ìƒ/ì¬ì§ˆ</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">ì œí’ˆ ì¹˜ìˆ˜</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">ë‹¨ì¡° ì¹˜ìˆ˜</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">ì—¬ìœ ì¹˜</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">Ingot / íšŒìˆ˜ìœ¨</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // í™˜ê²½ ê°ì§€ ë¡œì§
        const isVercel = window.location.hostname.includes('vercel.app');
        const envBadge = document.getElementById('envStatus');
        
        if (isVercel) {
            envBadge.innerHTML = '<span class="text-green-600">âœ… Vercel ë°°í¬ í™˜ê²½ (ì„œë²„ ì •ìƒ ì‘ë™)</span>';
        } else {
            envBadge.innerHTML = '<span class="text-orange-500">âš ï¸ ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ (ì„œë²„ ì—†ìŒ - ë¶„ì„ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ)</span>';
        }

        const fileInput = document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');
        const loading = document.getElementById('loading');
        const resultArea = document.getElementById('resultArea');
        const tableBody = document.getElementById('resultTableBody');

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('paste', e => {
            const items = e.clipboardData.items;
            for (let i=0; i<items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    processFile(items[i].getAsFile());
                    break;
                }
            }
        });
        fileInput.addEventListener('change', e => { if(e.target.files.length) processFile(e.target.files[0]); });
        dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('border-blue-500'); });
        dropzone.addEventListener('drop', e => { 
            e.preventDefault(); dropzone.classList.remove('border-blue-500');
            if(e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]); 
        });

        async function processFile(file) {
            loading.classList.remove('hidden');
            resultArea.classList.add('hidden');
            let uploadFile = file;

            try {
                // 1. ì „ì²˜ë¦¬ (ì—‘ì…€/ì´ë¯¸ì§€ -> í…ìŠ¤íŠ¸ ë³€í™˜)
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const ab = await file.arrayBuffer();
                    const wb = XLSX.read(ab);
                    // Active Sheet ì°¾ê¸°
                    let sheetName = wb.SheetNames[0];
                    if (wb.Workbook?.Views?.[0]?.ActiveTab) {
                        sheetName = wb.SheetNames[wb.Workbook.Views[0].ActiveTab] || sheetName;
                    }
                    const csv = XLSX.utils.sheet_to_csv(wb.Sheets[sheetName]);
                    uploadFile = new File([csv], "data.csv", { type: "text/csv" });
                } else if (file.type.startsWith('image/')) {
                    document.getElementById('loadingText').innerText = "ì´ë¯¸ì§€ ê¸€ì ì¸ì‹(OCR) ì¤‘...";
                    const worker = await Tesseract.createWorker('eng');
                    const ret = await worker.recognize(file);
                    await worker.terminate();
                    uploadFile = new File([ret.data.text], "ocr.txt", { type: "text/plain" });
                }

                // 2. ì„œë²„ ì „ì†¡
                if (!isVercel) {
                    // ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ì¼ ë• ê°€ì§œ ë°ì´í„° ë³´ì—¬ì¤Œ (ì—ëŸ¬ ë°©ì§€)
                    await new Promise(r => setTimeout(r, 1000));
                    alert("í˜„ì¬ëŠ” ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ì´ë¼ AI ë¶„ì„ ì„œë²„ê°€ ì—†ìŠµë‹ˆë‹¤.\nì„ì‹œ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
                    renderTable([{ 
                        rowId: "Test", productName: "SHAFT (Test)", material: "SA266",
                        inputSpec: {od:100, length:500}, outputSpec: {od:120, length:550},
                        note: "ì‹¤ì œ ë¶„ì„ì€ Vercel ë°°í¬ ì‚¬ì´íŠ¸ì—ì„œ í•˜ì„¸ìš”." 
                    }]);
                    return;
                }

                document.getElementById('loadingText').innerText = "AI ë¶„ì„ ìš”ì²­ ì¤‘...";
                const formData = new FormData();
                formData.append('file', uploadFile);

                const res = await fetch('/api/analyze', { method: 'POST', body: formData });
                if (!res.ok) throw new Error(await res.text());
                
                const result = await res.json();
                renderTable(result.data.items);

            } catch (err) {
                alert("ì˜¤ë¥˜: " + err.message);
            } finally {
                loading.classList.add('hidden');
                resultArea.classList.remove('hidden');
            }
        }

        function renderTable(items) {
            tableBody.innerHTML = items.map(item => `
                <tr>
                    <td class="px-6 py-4 text-sm">${item.rowId || '-'}</td>
                    <td class="px-6 py-4 text-sm font-bold">${item.productName}</td>
                    <td class="px-6 py-4 text-sm">${fmt(item.inputSpec)}</td>
                    <td class="px-6 py-4 text-sm text-blue-600">${fmt(item.outputSpec)}</td>
                    <td class="px-6 py-4 text-sm">${fmt(item.allowanceSpec) || 'Auto'}</td>
                    <td class="px-6 py-4 text-sm">${item.ingotType || '-'} / ${item.recoveryRate || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${item.note || ''}</td>
                </tr>
            `).join('');
        }

        function fmt(obj) {
            if (!obj) return '-';
            return Object.values(obj).join(' / ');
        }
    </script>
</body>
</html>
